{
    "title": "Smalldb Abstract State Machine",
    "type": "object",
    "required": [
        "class"
    ],
    "properties": {
        "_": {
            "description": "Token to stop PHP from interpreting the rest of the file. Ignored by Smalldb.",
            "type": "string",
            "pattern": "^<\\?php printf\\('_%c%c}%c',34,10,10\\);__halt_compiler\\(\\);\\?>$"
        },
        "class": {
            "description": "Interpreted by JsonDirBackend. PHP class name of transitions implementation.",
            "type": "string",
            "pattern": "^[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*(\\\\[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*)*$",
            "_annotation": "JsonDirBackend"
        },
        "include": {
            "description": "Interpreted by JsonDirBackend only. List of files to include and merge with this JSON file.",
            "type": "array",
            "_annotation": "JsonDirBackend",
            "items": {
                "description": "File name of the file to include or object containing the filename and additional options.",
                "type": [ "string", "object" ],
                "properties": {
                    "file": {
                        "description": "File name of the file to include.",
                        "type": "string",
                        "_annotation": "JsonDirBackend"
                    }
                },
                "additionalProperties": {
                    "description": "Options passed to dedicated reader.",
                    "_annotation": "JsonDirBackend"
                },
                "_annotation": "JsonDirBackend"
            }
        },
        "state_diagram_extras": {
            "description": "List of additional fragments of state diagram.",
            "type": "array",
            "items": {
                "description": "Dot source code to be added just before the end of the state diagram..",
                "type": "string"
            }
        },
        "properties": {
            "description": "State machine properties.",
            "type": "object",
            "additionalProperties": {
                "description": "State machine property definition",
                "type": "object",
                "properties": {
                }
            }
        },
        "states": {
            "description": "State machine states",
            "type": "object",
            "additionalProperties": {
                "description": "State of the state machine",
                "type": "object",
                "properties": {
                    "color": {
                        "description": "Color of the state in the state diagram (fillcolor). Visual effect only.",
                        "type": "string",
                        "pattern": "^#[0-9A-Fa-f]{6}$"
                    },
                    "group": {
                        "description": "Name of a group (subgraph) in the state diagram to which the state belongs. Visual effect only. See state_groups.",
                        "type": "string"
                    }
                }
            }
        },
        "state_groups": {
            "description": "Groups of states in the state machine diagram. Visual effect only.",
            "type": "object",
            "additionalProperties": {
                "description": "Group of states in the state machine diagram.",
                "type": "object",
                "required": [ "label" ],
                "additionalProperties": false,
                "properties": {
                    "label": {
                        "description": "Label of the group.",
                        "type": "string"
                    },
                    "color": {
                        "description": "Color of the group (border and label).",
                        "type": "string",
                        "pattern": "^#[0-9A-Fa-f]{6}$"
                    },
                    "state_groups": {
                        "description": "Recursively nested state groups (same as parent state_groups).",
                        "type": "object"
                    }
                }
            }
        },
        "actions": {
            "description": "State machine actions (groups of transitions of the same name).",
            "type": "object",
            "additionalProperties": {
                "description": "State machine action.",
                "type": "object",
                "properties": {
                    "transitions": {
                        "description": "Transitions of the action",
                        "type": "object",
                        "additionalProperties": {
                            "description": "Starting state of the transition.",
                            "type": "object",
                            "properties": {
                                "targets": {
                                    "description": "List of possible target states of the transition starting from this state.",
                                    "type": "array",
                                    "items": {
                                        "type": "string"
                                    }
                                }
                            },
                            "additionalProperties": {
                                "type": "object",
                                "description": "All properties are merged with action's properties; transition's properties have precedence."
                            }
                        }
                    },
                    "method": {
                        "description": "Name of PHP method which implements the transition.",
                        "type": "string",
                        "pattern": "^[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*$"
                    },
                    "args": {
                        "description": "Additional arguments prefixed to transition arguments when calling the method.",
                        "type": "array"
                    },
                    "pre_check_methods": {
                        "description": "Methods to call before the transition is invoked. All of these methods must not return false otherwise the transition is aborted.",
                        "type": "array",
                        "items": {
                            "type": "string",
                            "pattern": "^[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*$"
                        }
                    },
                    "returns": {
                        "description": "Semantics of return value of the method.",
                        "type": [ "string", "null" ]
                    },
                    "post_transition_methods": {
                        "description": "Methods to call after the transition is invoked.",
                        "type": "array",
                        "items": {
                            "type": "string",
                            "pattern": "^[a-zA-Z_\\x7f-\\xff][a-zA-Z0-9_\\x7f-\\xff]*$"
                        }
                    },
                    "color": {
                        "description": "Color of the arrow in the state diagram.",
                        "type": "string",
                        "pattern": "^#[0-9A-Fa-f]{6}$"
                    },
                    "weight": {
                        "description": "Weight of the arrow in the state diagram (heavier arrows are rendered shorter).",
                        "type": "number"
                    },
                    "access_policy": {
                        "description": "Name of required access policy, see access_policies.",
                        "type": "string"
                    }
                }
            }
        },
        "access_policies": {
            "description": "Access policies",
            "type": "object",
            "additionalProperties": {
                "description": "Access policy",
                "type": "object",
                "properties": {
                    "arrow_tail": {
                        "description": "Shape of arrow tail in the state diagram. Visual effect only. See http://www.graphviz.org/content/arrow-shapes.",
                        "type": "string",
                        "pattern": "^((|l|r|o|ol|or)box|(|l|r)crow|(l|r|o|ol|or)diamond|(|o)dot|(|l|r|o|ol|or)inv|none|(|l|r|o|ol|or)normal|(|l|r)tee|(|l|e)vee|(|l|r|i|li|ri)curve){1,4}$"
                    }
                }
            }
        },
        "default_access_policy": {
            "description": "Default access policy (used unless given action specifies another policy). See 'access_policies'.",
            "type": [ "string", "null" ]
        },
        "read_access_policy": {
            "description": "Access policy when reading state machine state and properties. See 'access_policies'.",
            "type": [ "string", "null" ]
        },
        "listing_access_policy": {
            "description": "Access policy when listing state machine instances (user may be able to read any state machine state, but may not be able to enumerate them). See 'access_policies'.",
            "type": [ "string", "null" ]
        }
    }
}

